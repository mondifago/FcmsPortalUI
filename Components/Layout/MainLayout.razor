@using FcmsPortalUI.Components.Pages.School
@using FcmsPortalUI.Services
@using FcmsPortal.Models
@inject ISchoolDataService SchoolDataService
@inject NavigationManager NavigationManager
@inject IPermissionService PermissionService
@inherits LayoutComponentBase

<div class="layout-container">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">
                    <h5>Initializing Portal...</h5>
                </div>
            </div>
        </div>
    }
    else
    {
        <AuthorizeView>
            <Authorized>
                @if (hasSchool && hasPrincipal)
                {
                    <div class="top-row">
                        <div class="logo-container">
                            <a href="/" class="brand-link">
                                <div class="brand-logo-circle">
                                    @if (school != null && !string.IsNullOrEmpty(school.LogoUrl))
                                    {
                                        <img src="@school.LogoUrl" alt="School Logo" />
                                    }
                                    else
                                    {
                                        <span class="brand-logo-initials">F</span>
                                    }
                                </div>
                                <span class="brand-text">FCMS</span>
                            </a>
                        </div>
                        <button class="navbar-toggler" @onclick="ToggleNavMenu">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="top-icons">
                            <input type="text" class="search-box" placeholder="Search...">
                            @*<a href="/notifications" class="icon-link"><i class="fas fa-bell"></i></a>*@
                            @if (canManageSchoolSettings)
                            {
                                <button class="icon-link" style="border: none; background: none;" @onclick="ShowSchoolSettings">
                                    <i class="fas fa-cog"></i>
                                </button>
                            }

                            <div class="profile-menu-wrapper" @onclick:stopPropagation="true">
                                <button class="icon-link profile-toggle-btn" @onclick="ToggleProfileMenu">
                                    <i class="fas fa-user-circle"></i>
                                </button>

                                @if (showProfileMenu)
                                {
                                    <div class="profile-panel">
                                        <div class="profile-header">
                                            @if (!string.IsNullOrEmpty(currentUserPhoto))
                                            {
                                                <img src="@currentUserPhoto" class="profile-photo" />
                                            }
                                            else
                                            {
                                                <div class="profile-initials-circle">
                                                    @Util.GetInitials(currentPerson)
                                                </div>
                                            }

                                            <div>
                                                <div class="profile-name">@currentUserName</div>
                                                <div class="profile-email">@currentUserEmail</div>

                                                <a href="/profile" class="profile-link">My profile</a>
                                                <a href="Account/Manage" class="profile-link">Account settings</a>
                                            </div>
                                        </div>

                                        <hr />

                                        <div class="flyout-signout-container">
                                            <a href="/Logout" class="profile-signout">
                                                Sign out
                                            </a>
                                        </div>

                                    </div>
                                }
                            </div>
                            @if (showProfileMenu)
                            {
                                <div class="profile-overlay" @onclick="CloseProfileMenu"></div>
                            }
                        </div>
                    </div>

                    <div class="page">
                        <NavMenu @ref="navMenu" HasSchool="@hasSchool" />
                        <main>
                            <article class="content px-4">
                                @Body
                            </article>
                        </main>
                    </div>
                    <SchoolSettingsModal IsVisible="showSchoolSettings"
                                         OnClose="CloseSchoolSettings"
                                         OnSave="HandleSchoolSettingsSaved" />
                }
                else
                {
                    <div class="top-row">
                        <div class="logo-container">
                            <a href="/" class="brand-link">
                                <div class="brand-logo-circle">
                                    @if (school != null && !string.IsNullOrEmpty(school.LogoUrl))
                                    {
                                        <img src="@school.LogoUrl" alt="School Logo" />
                                    }
                                    else
                                    {
                                        <span class="brand-logo-initials">F</span>
                                    }
                                </div>
                                <span class="brand-text">FCMS</span>
                            </a>
                        </div>
                    </div>

                }
            </Authorized>
            <NotAuthorized>
                @Body
            </NotAuthorized>
        </AuthorizeView>
    }
</div>

@code {
    private NavMenu? navMenu;
    private School? school;
    private bool collapseNavMenu = true;
    private bool showSchoolSettings = false;
    private bool hasSchool = false;
    private bool hasPrincipal = false;
    private bool isLoading = true;

    private bool showProfileMenu = false;
    private bool canManageSchoolSettings = false;

    private Person? currentPerson;
    private string? currentUserName = "";
    private string? currentUserEmail = "";
    private string currentUserPhoto = "";
    private int renderCount = 0;
    private int initCount = 0;


    protected override async Task OnInitializedAsync()
    {
        currentPerson = await PermissionService.GetCurrentPersonAsync();

        currentUserName = currentPerson != null ? $"{currentPerson.FirstName} {currentPerson.LastName}" : "User";
        currentUserEmail = currentPerson?.Email ?? "";
        if (!string.IsNullOrEmpty(currentPerson?.ProfilePictureUrl)) currentUserPhoto = currentPerson.ProfilePictureUrl;
        canManageSchoolSettings = await PermissionService.IsInAnyRoleAsync("Developer", "Principal");
        InitializeApp();
    }

    private void InitializeApp()
    {
        isLoading = true;
        StateHasChanged();

        hasSchool = SchoolDataService.HasSchool();

        if (!hasSchool)
        {
            var currentUri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
            if (!currentUri.StartsWith("school/create"))
            {
                NavigationManager.NavigateTo("/school/create", true);
                return;
            }
        }

        if (hasSchool)
        {
            school = SchoolDataService.GetSchoolBasicInfo();
            hasPrincipal = SchoolDataService.HasPrincipal();

            if (!hasPrincipal)
            {
                var currentUri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
                if (!currentUri.StartsWith("principal/create"))
                {
                    NavigationManager.NavigateTo("/principal/create", true);
                    return;
                }
            }
        }

        isLoading = false;
        StateHasChanged();
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
        navMenu?.Toggle(collapseNavMenu);
    }

    private void ShowSchoolSettings()
    {
        showSchoolSettings = true;
    }

    private void CloseSchoolSettings()
    {
        showSchoolSettings = false;
    }

    private void HandleSchoolSettingsSaved()
    {
        FcmsPortalUI.Components.Pages.School.Home.TriggerSchoolDataRefresh();
        showSchoolSettings = false;
        StateHasChanged();
    }

    private void ToggleProfileMenu()
    {
        showProfileMenu = !showProfileMenu;
    }

    private void CloseProfileMenu()
    {
        showProfileMenu = false;
    }
}
