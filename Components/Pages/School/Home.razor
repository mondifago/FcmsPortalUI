@page "/"
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject ISchoolDataService SchoolDataService
@inject IPermissionService PermissionService
@using FcmsPortalUI.Components.Pages.Shared
@using FcmsPortalUI.Services
@using FcmsPortal.Models
@using FcmsPortal.Enums
@using FcmsPortal.Constants
@using FcmsPortal
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@implements IDisposable


<div class="container-fluid py-4">
    <!-- Welcome Banner -->
    <div class="welcome-banner mb-4">
        <div class="welcome-banner-content">
            <div class="welcome-top-row">
                <h2 class="welcome-title mb-0">
                    Welcome, <span class="welcome-name">@userFirstName</span>
                </h2>
                <div class="welcome-date">
                    @currentDateTime.ToString("dddd, MMMM d, yyyy")
                    <br />
                    <span class="welcome-time">@currentDateTime.ToString("hh:mm tt")</span>
                </div>
            </div>
            @if (randomQuote != null)
            {
                <p class="welcome-quote mb-0">
                    "@randomQuote.Text" — <span class="welcome-quote-author">@randomQuote.Author</span>
                </p>
            }
        </div>
    </div>

    <!-- Main Body -->
    <div class="row">
        <!-- Left Main Content -->
        <div class="col-lg-9">


            <!-- Horizontal Info Bar - Staff View -->
            <AuthorizeView Roles="Developer,Staff">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row text-center align-items-center">
                                <!-- Quick Links or General Info -->
                                <div class="col-md-12">
                                    <i class="fa fa-briefcase text-info me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted">
                                        Your work schedule and duties can be found in the
                                        <a href="/staff-resources" class="text-decoration-none">Staff Resources</a> section.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Teacher View -->
            <AuthorizeView Roles="Developer,Teacher">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/teacher-dashboard" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-6 border-end">
                                    <i class="fa fa-chalkboard-teacher text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Today's Classes</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Mathematics - Grade 10A at 9:00 AM</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">4 classes scheduled today</span>
                                </div>

                                <!-- Submitted Homework -->
                                <div class="col-md-6">
                                    <i class="fa fa-file-alt text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Homework Submissions</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">15 new submissions</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">Pending review from 3 classes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Student View -->
            <AuthorizeView Roles="Developer,Student">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-4 border-end">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-chalkboard-teacher text-primary" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Today's Classes</span>
                                    </div>
                                    @if (todayStudentClasses.Any())
                                    {
                                        @foreach (var schedule in todayStudentClasses)
                                        {
                                            <div class="mb-1">
                                                <strong style="font-size: 0.95rem;">@schedule.ClassSession?.Course</strong>
                                                <span class="text-muted" style="font-size: 0.85rem;">at @schedule.DateTime.ToString("h:mm tt")</span>
                                            </div>
                                        }
                                        @if (currentStudent?.LearningPathId > 0)
                                        {
                                            <a href="/learningpath/@currentStudent.LearningPathId/schedules?date=@DateTime.Today.ToString("yyyy-MM-dd")"
                                               class="text-decoration-none" style="font-size: 0.85rem;">
                                                View All <i class="fa fa-arrow-right ms-1"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0" style="font-size: 0.85rem;">
                                            <em>No classes scheduled today.</em>
                                        </p>
                                    }
                                </div>

                                <!-- Pending Homework -->
                                <div class="col-md-4 border-end">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-tasks text-warning" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Pending Homework</span>
                                    </div>
                                    @if (pendingStudentHomework.Any())
                                    {
                                        @foreach (var homework in pendingStudentHomework)
                                        {
                                            <div class="mb-1 text-center">
                                                <strong style="font-size: 0.95rem;">@homework.Title</strong>
                                                <span class="text-muted d-block" style="font-size: 0.85rem;">
                                                    Due: @homework.DueDate.ToString("MMM d, yyyy")
                                                </span>
                                            </div>
                                        }
                                        @if (currentStudent?.LearningPathId > 0)
                                        {
                                            <a href="/learningpath/@currentStudent.LearningPathId/schedules?date=@DateTime.Today.ToString("yyyy-MM-dd")"
                                               class="text-decoration-none" style="font-size: 0.85rem;">
                                                View All <i class="fa fa-arrow-right ms-1"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0 text-center" style="font-size: 0.85rem;">
                                            <em>No pending homework.</em>
                                        </p>
                                    }
                                </div>

                                <!-- Recent Grades -->
                                <div class="col-md-4">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-award text-success" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Recent Grades</span>
                                    </div>
                                    @if (recentStudentGrades.Any())
                                    {
                                        @foreach (var grade in recentStudentGrades)
                                        {
                                            <div class="mb-1 text-center">
                                                <strong style="font-size: 0.95rem;">@grade.Course @grade.GradeType</strong>
                                                <span class="text-muted" style="font-size: 0.85rem;">@grade.Score</span>
                                            </div>
                                        }
                                        @if (currentStudent != null && studentLearningPath != null)
                                        {
                                            <div class="text-center mt-2">
                                                <a href="javascript:void(0)" @onclick="ShowStudentGradeDetailsModal"
                                                   class="text-decoration-none" style="font-size: 0.85rem;">
                                                    View All <i class="fa fa-arrow-right ms-1"></i>
                                                </a>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0 text-center" style="font-size: 0.85rem;">
                                            <em>No grades recorded yet.</em>
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Guardian View -->
            <AuthorizeView Roles="Developer,Guardian">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/student-dashboard" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-chalkboard-teacher text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's Today's Classes</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Mathematics at 9:00 AM</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">5 classes scheduled</span>
                                </div>

                                <!-- Pending Homework -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-tasks text-warning me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's Pending Homework</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">2 assignments due today</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">Science & English</span>
                                </div>

                                <!-- Recent Grades -->
                                <div class="col-md-4">
                                    <i class="fa fa-award text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's New Grades Available</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Math Quiz - 85%</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">2 more results ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Admin/Principal/Developer View -->
            <AuthorizeView Roles="Developer,Principal,Admin">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/reports" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Attendance Report -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-user-check text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Attendance Report</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 9:00 AM</strong>
                                </div>

                                <!-- Teachers Remark Report -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-comments text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Teachers Remark</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 10:30 AM</strong>
                                </div>

                                <!-- Learning Path Report -->
                                <div class="col-md-4">
                                    <i class="fa fa-chart-line text-info me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Learning Path Report</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 2:15 PM</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-3">
            <div class="sidebar-container">
                <!-- Academic Year & Term -->
                <div class="sidebar-card sidebar-academic">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-graduation-cap me-2"></i>Academic Year & Term
                    </h6>
                    <div class="sidebar-card-body">
                        @if (!string.IsNullOrEmpty(currentAcademicYear))
                        {
                            <div class="sidebar-item">
                                <i class="fa fa-calendar-alt sidebar-item-icon"></i>
                                <div>
                                    <div><strong>@currentAcademicYear - @currentSemester.ToTermDisplay()</strong></div>
                                    <div>Term Start: @semesterStartDate?.ToString("MMM dd, yyyy")</div>
                                    <div>Term Ends: @semesterEndDate?.ToString("MMM dd, yyyy")</div>
                                    @if (examsStartDate.HasValue)
                                    {
                                        <div>Exam Start: @examsStartDate.Value.ToString("MMM dd, yyyy")</div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="sidebar-item">
                                <i class="fa fa-info-circle sidebar-item-icon"></i>
                                <div><em>No active term set.</em></div>
                            </div>
                            <div class="sidebar-item sidebar-item-empty">
                                <div><em>Check back soon!</em></div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Announcements -->
                <div class="sidebar-card sidebar-half">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-bell me-2"></i>Announcements
                    </h6>
                    <div class="sidebar-card-body">
                        <div class="sidebar-item">
                            @if (announcements != null && announcements.Any())
                            {
                                @foreach (var announcement in announcements)
                                {
                                    <div class="sidebar-item">
                                        <i class="fa fa-circle sidebar-item-bullet text-danger"></i>
                                        <div><small>@announcement.Message</small></div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted"><em>No Announcements for now!</em></div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Upcoming Events & Meetings -->
                <div class="sidebar-card sidebar-half">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-calendar-day me-2"></i>Upcoming Events
                    </h6>
                    <div class="sidebar-card-body">
                        @{
                            var events = new List<(string Label, ScheduleEntry Entry)>();
                            if (todayEventOrMeeting != null) events.Add(("Today", todayEventOrMeeting));
                            if (tomorrowEventOrMeeting != null) events.Add(("Tomorrow", tomorrowEventOrMeeting));
                            if (dayAfterEventOrMeeting != null && events.Count < 2) events.Add(("In 2 days", dayAfterEventOrMeeting));
                        }
                        @if (events.Any())
                        {
                            @foreach (var evt in events.Take(2))
                            {
                                <div class="sidebar-item">
                                    <i class="fa fa-calendar-check sidebar-item-icon"></i>
                                    <div>
                                        <strong>@evt.Label:</strong> @GetEventOrMeetingName(evt.Entry)
                                        <br /><small>at @evt.Entry.DateTime.ToString("h:mm tt")</small>
                                    </div>
                                </div>
                            }
                            @if (events.Count < 2)
                            {
                                <div class="sidebar-item sidebar-item-empty"></div>
                            }
                        }
                        else
                        {
                            <div class="sidebar-item">
                                <div class="text-muted"><em>No upcoming events.</em></div>
                            </div>
                            <div class="sidebar-item sidebar-item-empty"></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Student Grade Details Modal -->
    @if (currentStudent != null && studentLearningPath != null)
    {
        <StudentGradeDetailsModal IsVisible="showStudentGradeDetailsModal"
                                  Student="currentStudent"
                                  LearningPath="studentLearningPath"
                                  OnClose="CloseStudentGradeDetailsModal" />
    }
</div>

@code {
    //private School? school;
    private string userFirstName = "User";
    private DateTime currentDateTime = DateTime.Now;
    private System.Threading.Timer? timer;
    // Semester Timeline Data
    private string currentAcademicYear = "";
    private string currentSemester = "";
    private DateTime? semesterStartDate;
    private DateTime? semesterEndDate;
    private DateTime? examsStartDate;

    private List<Announcement> announcements = new();
    private Quote? randomQuote;

    private ScheduleEntry? todayEventOrMeeting;
    private ScheduleEntry? tomorrowEventOrMeeting;
    private ScheduleEntry? dayAfterEventOrMeeting;

    private static event Action? RefreshRequested;
    private static object refreshLock = new object();

    // Student Dashboard Data
    private Student? currentStudent;
    private List<ScheduleEntry> todayStudentClasses = new();
    private List<Homework> pendingStudentHomework = new();
    private List<(string Course, GradeType GradeType, double Score)> recentStudentGrades = new();
    private LearningPath? studentLearningPath;
    private bool showStudentGradeDetailsModal = false;

    protected override async Task OnInitializedAsync()
    {
        lock (refreshLock)
        {
            RefreshRequested += HandleRefreshRequest;
        }

        var person = await PermissionService.GetCurrentPersonAsync();
        if (person != null && !string.IsNullOrWhiteSpace(person.FirstName))
        {
            userFirstName = person.FirstName;
        }
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
        await LoadStudentDashboardData();
        timer = new System.Threading.Timer(UpdateTime, null, TimeSpan.Zero, TimeSpan.FromSeconds(60));
    }

    public static void TriggerSchoolDataRefresh()
    {
        lock (refreshLock)
        {
            RefreshRequested?.Invoke();
        }
    }

    private void HandleRefreshRequest()
    {
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
    }

    private void LoadSemesterTimeline()
    {
        var academicPeriod = SchoolDataService.GetCurrentAcademicPeriod();

        if (academicPeriod != null)
        {
            currentAcademicYear = academicPeriod.AcademicYear;
            currentSemester = academicPeriod.Semester.ToString();
            semesterStartDate = academicPeriod.SemesterStartDate;
            semesterEndDate = academicPeriod.SemesterEndDate;
            examsStartDate = academicPeriod.ExamsStartDate;
        }
    }

    private void LoadAnnouncements()
    {
        announcements = SchoolDataService.GetActiveAnnouncements();
    }

    private void LoadRandomQuote()
    {
        var quotes = SchoolDataService.GetAllQuotes();
        randomQuote = LogicMethods.GetRandomQuote(quotes);
    }

    private void LoadUpcomingEvents()
    {
        todayEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today);
        tomorrowEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(1));
        dayAfterEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(2));
    }

    private string GetEventOrMeetingName(ScheduleEntry entry)
    {
        return entry.Title;
    }

    private void UpdateTime(object? state)
    {
        currentDateTime = DateTime.Now;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadStudentDashboardData()
    {
        var person = await PermissionService.GetCurrentPersonAsync();
        if (person == null) return;

        currentStudent = SchoolDataService.GetStudents()
            .FirstOrDefault(s => s.PersonId == person.Id);

        if (currentStudent != null)
        {
            todayStudentClasses = SchoolDataService.GetTodayClassSessionsForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            pendingStudentHomework = SchoolDataService.GetPendingHomeworkForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            recentStudentGrades = SchoolDataService.GetRecentGradesForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);

            if (currentStudent.LearningPathId > 0)
            {
                studentLearningPath = SchoolDataService.GetLearningPathForGradeManagement(currentStudent.LearningPathId ?? 0);
            }
        }
    }

    private void ShowStudentGradeDetailsModal()
    {
        if (currentStudent != null && studentLearningPath != null)
        {
            showStudentGradeDetailsModal = true;
        }
    }

    private void CloseStudentGradeDetailsModal()
    {
        showStudentGradeDetailsModal = false;
    }

    public void Dispose()
    {
        timer?.Dispose();

        lock (refreshLock)
        {
            RefreshRequested -= HandleRefreshRequest;
        }
    }

}