@page "/"
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject ISchoolDataService SchoolDataService
@inject IPermissionService PermissionService
@using FcmsPortalUI.Components.Pages.Shared
@using FcmsPortalUI.Services
@using FcmsPortal.Models
@using FcmsPortal.Enums
@using FcmsPortal.Constants
@using FcmsPortal
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@implements IDisposable


<div class="container-fluid py-4">
    <!-- Welcome Banner -->
    <div class="welcome-banner mb-4">
        <div class="welcome-banner-content">
            <div class="welcome-top-row">
                <h2 class="welcome-title mb-0">
                    Welcome, <span class="welcome-name">@userFirstName</span>
                </h2>
                <div class="welcome-date">
                    @currentDateTime.ToString("dddd, MMMM d, yyyy")
                    <br />
                    <span class="welcome-time">@currentDateTime.ToString("hh:mm tt")</span>
                </div>
            </div>
            @if (randomQuote != null)
            {
                <p class="welcome-quote mb-0">
                    "@randomQuote.Text" — <span class="welcome-quote-author">@randomQuote.Author</span>
                </p>
            }
        </div>
    </div>

    <!-- Main Body -->
    <div class="row">
        <!-- Left Main Content -->
        <div class="col-lg-9">


            <!-- Horizontal Info Bar - Staff View -->
            <AuthorizeView Roles="Developer,Staff">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row text-center align-items-center">
                                <!-- Quick Links or General Info -->
                                <div class="col-md-12">
                                    <i class="fa fa-briefcase text-info me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted">
                                        Your work schedule and duties can be found in the
                                        <a href="/staff-resources" class="text-decoration-none">Staff Resources</a> section.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Teacher View -->
            <AuthorizeView Roles="Developer,Teacher">
                <Authorized>
                    <div class="hbar-container">
                        <!-- Today's Classes -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-chalkboard-teacher me-2"></i>My Classes Today
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (todayTeacherClasses.Any())
                                    {
                                        @foreach (var schedule in todayTeacherClasses)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-book-open hbar-row-icon"></i>
                                                <span>
                                                    <strong>@schedule.ClassSession?.Course</strong>
                                                    at @schedule.DateTime.ToString("h:mm tt")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No classes today.</em>
                                        </div>
                                    }
                                </div>
                                @if (todayTeacherClasses.Any() && todayTeacherClasses.First().LearningPathId > 0)
                                {
                                    <div class="hbar-view-all">
                                        <a href="/learningpath/@todayTeacherClasses.First().LearningPathId/schedules/@DateTime.Today.ToString("yyyy-MM-dd")"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Homework Submitted -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-clipboard-check me-2"></i>Homework Submitted
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (recentHomeworkSubmissions.Any())
                                    {
                                        @foreach (var sub in recentHomeworkSubmissions)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-pen-to-square hbar-row-icon"></i>
                                                <span>
                                                    <strong>@sub.StudentName</strong>
                                                    — @sub.Course
                                                    <br /><small>@sub.SubmittedDate.ToString("MMM d, h:mm tt")</small>
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No submissions yet.</em>
                                        </div>
                                    }
                                </div>
                                @if (todayTeacherClasses.Any() && todayTeacherClasses.First().LearningPathId > 0)
                                {
                                    <div class="hbar-view-all">
                                        <a href="/learningpath/@todayTeacherClasses.First().LearningPathId/schedules/@DateTime.Today.ToString("yyyy-MM-dd")"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Student View -->
            <AuthorizeView Roles="Developer,Student">
                <Authorized>
                    <div class="hbar-container">
                        <!-- Today's Classes -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-chalkboard-teacher me-2"></i>Today's Classes
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (todayStudentClasses.Any())
                                    {
                                        @foreach (var schedule in todayStudentClasses)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-book-open hbar-row-icon"></i>
                                                <span>
                                                    <strong>@schedule.ClassSession?.Course</strong>
                                                    at @schedule.DateTime.ToString("h:mm tt")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No classes today.</em>
                                        </div>
                                    }
                                </div>
                                @if (currentStudent?.LearningPathId > 0)
                                {
                                    <div class="hbar-view-all">
                                        <a href="/learningpath/@currentStudent.LearningPathId/schedules/@DateTime.Today.ToString("yyyy-MM-dd")"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Pending Homework -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-clipboard-check me-2"></i>Pending Homework
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (pendingStudentHomework.Any())
                                    {
                                        @foreach (var homework in pendingStudentHomework)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-pen-to-square hbar-row-icon"></i>
                                                <span>
                                                    <strong>@homework.Title</strong>
                                                    — Due: @homework.DueDate.ToString("MMM d")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">All caught up!</em>
                                        </div>
                                    }
                                </div>
                                @if (currentStudent?.LearningPathId > 0)
                                {
                                    <div class="hbar-view-all">
                                        <a href="/learningpath/@currentStudent.LearningPathId/schedules/@DateTime.Today.ToString("yyyy-MM-dd")"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Recent Grades -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-star me-2"></i>Recent Grades
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (recentStudentGrades.Any())
                                    {
                                        @foreach (var grade in recentStudentGrades)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-trophy hbar-row-icon"></i>
                                                <span>
                                                    <strong>@grade.Course</strong>
                                                    @grade.GradeType — @grade.Score
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No grades yet.</em>
                                        </div>
                                    }
                                </div>
                                @if (currentStudent != null && studentLearningPath != null)
                                {
                                    <div class="hbar-view-all">
                                        <a href="javascript:void(0)" @onclick="ShowStudentGradeDetailsModal"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Guardian View -->
            <AuthorizeView Roles="Developer,Guardian">
                <Authorized>
                    <div class="hbar-container">
                        <!-- Ward's Today's Classes -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-chalkboard-teacher me-2"></i>Ward's Classes Today
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (wardTodayClasses.Any())
                                    {
                                        @foreach (var item in wardTodayClasses)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-book-open hbar-row-icon"></i>
                                                <span>
                                                    <strong>@item.WardName:</strong>
                                                    @item.Schedule.ClassSession?.Course
                                                    at @item.Schedule.DateTime.ToString("h:mm tt")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No classes today.</em>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Ward's Pending Homework -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-clipboard-check me-2"></i>Ward's Pending Homework
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (wardPendingHomework.Any())
                                    {
                                        @foreach (var item in wardPendingHomework)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-pen-to-square hbar-row-icon"></i>
                                                <span>
                                                    <strong>@item.WardName:</strong>
                                                    @item.Homework.Title
                                                    — Due: @item.Homework.DueDate.ToString("MMM d")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">All caught up!</em>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Ward's Recent Grades -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-star me-2"></i>Ward's Recent Grades
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (wardRecentGrades.Any())
                                    {
                                        @foreach (var grade in wardRecentGrades)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-trophy hbar-row-icon"></i>
                                                <span>
                                                    <strong>@grade.WardName:</strong>
                                                    @grade.Course @grade.GradeType — @grade.Score
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No grades yet.</em>
                                        </div>
                                    }
                                </div>
                                @if (currentGuardian?.Wards != null && currentGuardian.Wards.Any())
                                {
                                    <div class="hbar-view-all">
                                        <a href="javascript:void(0)"
                                           @onclick="() => ShowWardGradeDetailsModal(currentGuardian.Wards.First())"
                                           class="text-decoration-none">
                                            View All <i class="fa fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Count Cards - Admin/Principal/Developer View -->
            <AuthorizeView Roles="Developer,Principal,Admin, Staff">
                <Authorized>
                    <div class="hbar-container">
                        <div class="count-card">
                            <div class="count-card-icon">
                                <i class="fa fa-user-tie"></i>
                            </div>
                            <div class="count-card-divider"></div>
                            <div class="count-card-info">
                                <span class="count-card-label">Staff</span>
                                <span class="count-card-value">@staffCount</span>
                            </div>
                        </div>

                        <div class="count-card">
                            <div class="count-card-icon">
                                <i class="fa fa-user-graduate"></i>
                            </div>
                            <div class="count-card-divider"></div>
                            <div class="count-card-info">
                                <span class="count-card-label">Students</span>
                                <span class="count-card-value">@studentCount</span>
                            </div>
                        </div>

                        <div class="count-card">
                            <div class="count-card-icon">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="count-card-divider"></div>
                            <div class="count-card-info">
                                <span class="count-card-label">Guardians</span>
                                <span class="count-card-value">@guardianCount</span>
                            </div>
                        </div>

                        <div class="count-card">
                            <div class="count-card-icon">
                                <i class="fa fa-chalkboard"></i>
                            </div>
                            <div class="count-card-divider"></div>
                            <div class="count-card-info">
                                <span class="count-card-label">Classes</span>
                                <span class="count-card-value">@classCount</span>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Admin/Principal/Developer View -->
            <AuthorizeView Roles="Developer,Principal,Admin">
                <Authorized>
                    <div class="hbar-container">
                        <!-- Attendance Reports -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-clipboard-user me-2"></i>Attendance Reports
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (todayAttendanceReports.Any())
                                    {
                                        @foreach (var report in todayAttendanceReports)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-check-circle hbar-row-icon"></i>
                                                <span>
                                                    <strong>@report.LearningPathName</strong>
                                                    at @report.Timestamp.ToString("h:mm tt")
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No attendance taken today.</em>
                                        </div>
                                    }
                                </div>
                                <div class="hbar-view-all">
                                    <a href="/reports" class="text-decoration-none">
                                        View All <i class="fa fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Teacher Remarks -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-comment-dots me-2"></i>Teacher Remarks
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (todayTeacherRemarks.Any())
                                    {
                                        @foreach (var remark in todayTeacherRemarks)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-chalkboard hbar-row-icon"></i>
                                                <span>
                                                    <strong>@remark.Course</strong> — <small>at @remark.Timestamp.ToString("h:mm tt")</small>
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No remarks submitted today.</em>
                                        </div>
                                    }
                                </div>
                                <div class="hbar-view-all">
                                    <a href="/reports" class="text-decoration-none">
                                        View All <i class="fa fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Submitted Learning Paths -->
                        <div class="hbar-card">
                            <h6 class="hbar-card-title">
                                <i class="fa fa-paper-plane me-2"></i>Submitted Learning Paths
                            </h6>
                            <div class="hbar-card-body">
                                <div class="hbar-item">
                                    @if (recentSubmittedLearningPaths.Any())
                                    {
                                        @foreach (var lp in recentSubmittedLearningPaths)
                                        {
                                            <div class="hbar-row">
                                                <i class="fa fa-file-circle-check hbar-row-icon"></i>
                                                <span>
                                                    <strong>@lp.LearningPathName</strong>
                                                    <br /><small>@lp.DateSubmitted.ToString("MMM d, h:mm tt")</small>
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="hbar-row">
                                            <em class="text-muted">No recent submissions.</em>
                                        </div>
                                    }
                                </div>
                                <div class="hbar-view-all">
                                    <a href="/reports" class="text-decoration-none">
                                        View All <i class="fa fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>
        <!-- Right Sidebar -->
        <div class="col-lg-3">
            <div class="sidebar-container">
                <!-- Academic Year & Term -->
                <div class="sidebar-card sidebar-academic">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-graduation-cap me-2"></i>Academic Year
                    </h6>
                    <div class="sidebar-card-body">
                        @if (!string.IsNullOrEmpty(currentAcademicYear))
                        {
                            <div class="sidebar-item">
                                <i class="fa fa-calendar-alt sidebar-item-icon"></i>
                                <div>
                                    <div><strong>@currentAcademicYear - @currentSemester.ToTermDisplay()</strong></div>
                                    <div>Term Start: @semesterStartDate?.ToString("MMM dd, yyyy")</div>
                                    <div>Term Ends: @semesterEndDate?.ToString("MMM dd, yyyy")</div>
                                    @if (examsStartDate.HasValue)
                                    {
                                        <div>Exam Start: @examsStartDate.Value.ToString("MMM dd, yyyy")</div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="sidebar-item">
                                <i class="fa fa-info-circle sidebar-item-icon"></i>
                                <div><em>No active term set.</em></div>
                            </div>
                            <div class="sidebar-item sidebar-item-empty">
                                <div><em>Check back soon!</em></div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Announcements -->
                <div class="sidebar-card sidebar-half">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-bell me-2"></i>Announcements
                    </h6>
                    <div class="sidebar-card-body">
                        @if (announcements != null && announcements.Any())
                        {
                            @foreach (var announcement in announcements.Take(2))
                            {
                                <div class="sidebar-item">
                                    <i class="fa fa-circle sidebar-item-bullet text-danger"></i>
                                    <div>@announcement.Message</div>
                                </div>
                            }
                            @if (announcements.Count < 2)
                            {
                                <div class="sidebar-item sidebar-item-empty"></div>
                            }
                        }
                        else
                        {
                            <div class="sidebar-item">
                                <div class="text-muted"><em>All clear for now!</em></div>
                            </div>
                            <div class="sidebar-item sidebar-item-empty"></div>
                        }
                    </div>
                </div>

                <!-- Upcoming Events & Meetings -->
                <div class="sidebar-card sidebar-half">
                    <h6 class="sidebar-card-title">
                        <i class="fa fa-calendar-day me-2"></i>Upcoming Events
                    </h6>
                    <div class="sidebar-card-body">
                        @{
                            var events = new List<(string Label, ScheduleEntry Entry)>();
                            if (todayEventOrMeeting != null) events.Add(("Today", todayEventOrMeeting));
                            if (tomorrowEventOrMeeting != null) events.Add(("Tomorrow", tomorrowEventOrMeeting));
                            if (dayAfterEventOrMeeting != null && events.Count < 2) events.Add(("In 2 days", dayAfterEventOrMeeting));
                        }
                        @if (events.Any())
                        {
                            @foreach (var evt in events.Take(2))
                            {
                                <div class="sidebar-item">
                                    <i class="fa fa-calendar-check sidebar-item-icon"></i>
                                    <div>
                                        <strong>@evt.Label:</strong> @GetEventOrMeetingName(evt.Entry)
                                        <br /><small>at @evt.Entry.DateTime.ToString("h:mm tt")</small>
                                    </div>
                                </div>
                            }
                            @if (events.Count < 2)
                            {
                                <div class="sidebar-item sidebar-item-empty"></div>
                            }
                        }
                        else
                        {
                            <div class="sidebar-item">
                                <div class="text-muted"><em>No upcoming events.</em></div>
                            </div>
                            <div class="sidebar-item sidebar-item-empty"></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Student Grade Details Modal -->
    @if (currentStudent != null && studentLearningPath != null)
    {
        <StudentGradeDetailsModal IsVisible="showStudentGradeDetailsModal"
                                  Student="currentStudent"
                                  LearningPath="studentLearningPath"
                                  OnClose="CloseStudentGradeDetailsModal" />
    }

    <!-- Guardian Ward Grade Details Modal -->
    @if (selectedWardForGrades != null && selectedWardLearningPath != null)
    {
        <StudentGradeDetailsModal IsVisible="showGuardianGradeDetailsModal"
                                  Student="selectedWardForGrades"
                                  LearningPath="selectedWardLearningPath"
                                  OnClose="CloseGuardianGradeDetailsModal" />
    }
</div>

@code {
    //private School? school;
    private string userFirstName = "User";
    private DateTime currentDateTime = DateTime.Now;
    private System.Threading.Timer? timer;
    // Semester Timeline Data
    private string currentAcademicYear = "";
    private string currentSemester = "";
    private DateTime? semesterStartDate;
    private DateTime? semesterEndDate;
    private DateTime? examsStartDate;

    private List<Announcement> announcements = new();
    private Quote? randomQuote;

    private ScheduleEntry? todayEventOrMeeting;
    private ScheduleEntry? tomorrowEventOrMeeting;
    private ScheduleEntry? dayAfterEventOrMeeting;

    private static event Action? RefreshRequested;
    private static object refreshLock = new object();

    // Student Dashboard Data
    private Student? currentStudent;
    private List<ScheduleEntry> todayStudentClasses = new();
    private List<Homework> pendingStudentHomework = new();
    private List<(string Course, GradeType GradeType, double Score)> recentStudentGrades = new();
    private LearningPath? studentLearningPath;
    private bool showStudentGradeDetailsModal = false;

    // Admin/Principal Dashboard Data
    private List<(string LearningPathName, DateTime Timestamp)> todayAttendanceReports = new();
    private List<(string Course, string Topic, DateTime Timestamp)> todayTeacherRemarks = new();
    private List<(string LearningPathName, DateTime DateSubmitted)> recentSubmittedLearningPaths = new();
    private int staffCount;
    private int studentCount;
    private int guardianCount;
    private int classCount;

    // Guardian Dashboard Data
    private Guardian? currentGuardian;
    private List<(string WardName, ScheduleEntry Schedule)> wardTodayClasses = new();
    private List<(string WardName, Homework Homework)> wardPendingHomework = new();
    private List<(string WardName, string Course, GradeType GradeType, double Score)> wardRecentGrades = new();
    private bool showGuardianGradeDetailsModal = false;
    private Student? selectedWardForGrades;
    private LearningPath? selectedWardLearningPath;

    // Teacher Dashboard Data
    private Staff? currentTeacher;
    private List<ScheduleEntry> todayTeacherClasses = new();
    private List<(string Course, string StudentName, DateTime SubmittedDate)> recentHomeworkSubmissions = new();

    protected override async Task OnInitializedAsync()
    {
        lock (refreshLock)
        {
            RefreshRequested += HandleRefreshRequest;
        }

        var person = await PermissionService.GetCurrentPersonAsync();
        if (person != null && !string.IsNullOrWhiteSpace(person.FirstName))
        {
            userFirstName = person.FirstName;
        }
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
        await LoadAdminDashboardData();
        await LoadStudentDashboardData();
        await LoadGuardianDashboardData();
        await LoadTeacherDashboardData();
        timer = new System.Threading.Timer(UpdateTime, null, TimeSpan.Zero, TimeSpan.FromSeconds(60));
    }

    public static void TriggerSchoolDataRefresh()
    {
        lock (refreshLock)
        {
            RefreshRequested?.Invoke();
        }
    }

    private void HandleRefreshRequest()
    {
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
    }

    private void LoadSemesterTimeline()
    {
        var academicPeriod = SchoolDataService.GetCurrentAcademicPeriod();

        if (academicPeriod != null)
        {
            currentAcademicYear = academicPeriod.AcademicYear;
            currentSemester = academicPeriod.Semester.ToString();
            semesterStartDate = academicPeriod.SemesterStartDate;
            semesterEndDate = academicPeriod.SemesterEndDate;
            examsStartDate = academicPeriod.ExamsStartDate;
        }
    }

    private void LoadAnnouncements()
    {
        announcements = SchoolDataService.GetActiveAnnouncements();
    }

    private void LoadRandomQuote()
    {
        var quotes = SchoolDataService.GetAllQuotes();
        randomQuote = LogicMethods.GetRandomQuote(quotes);
    }

    private void LoadUpcomingEvents()
    {
        todayEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today);
        tomorrowEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(1));
        dayAfterEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(2));
    }

    private string GetEventOrMeetingName(ScheduleEntry entry)
    {
        return entry.Title;
    }

    private void UpdateTime(object? state)
    {
        currentDateTime = DateTime.Now;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadStudentDashboardData()
    {
        var person = await PermissionService.GetCurrentPersonAsync();
        if (person == null) return;

        currentStudent = SchoolDataService.GetStudents()
            .FirstOrDefault(s => s.PersonId == person.Id);

        if (currentStudent != null)
        {
            todayStudentClasses = SchoolDataService.GetTodayClassSessionsForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            pendingStudentHomework = SchoolDataService.GetPendingHomeworkForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            recentStudentGrades = SchoolDataService.GetRecentGradesForStudent(currentStudent.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);

            if (currentStudent.LearningPathId > 0)
            {
                studentLearningPath = SchoolDataService.GetLearningPathForGradeManagement(currentStudent.LearningPathId ?? 0);
            }
        }
    }

    private async Task LoadAdminDashboardData()
    {
        if (!await PermissionService.IsInAnyRoleAsync("Developer", "Principal", "Admin"))
            return;

        staffCount = SchoolDataService.GetStaffCount();
        studentCount = SchoolDataService.GetStudentCount();
        guardianCount = SchoolDataService.GetGuardianCount();
        classCount = SchoolDataService.GetActiveClassCount();
        todayAttendanceReports = SchoolDataService.GetTodayAttendanceReports(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
        todayTeacherRemarks = SchoolDataService.GetTodayTeacherRemarks(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
        recentSubmittedLearningPaths = SchoolDataService.GetRecentlySubmittedLearningPaths(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
    }

    private void ShowStudentGradeDetailsModal()
    {
        if (currentStudent != null && studentLearningPath != null)
        {
            showStudentGradeDetailsModal = true;
        }
    }

    private void CloseStudentGradeDetailsModal()
    {
        showStudentGradeDetailsModal = false;
    }

    private async Task LoadGuardianDashboardData()
    {
        var person = await PermissionService.GetCurrentPersonAsync();
        if (person == null) return;

        currentGuardian = SchoolDataService.GetGuardians()
            .FirstOrDefault(g => g.PersonId == person.Id);

        if (currentGuardian == null || currentGuardian.Wards == null) return;

        foreach (var ward in currentGuardian.Wards)
        {
            var wardName = ward.Person.FirstName;

            var classes = SchoolDataService.GetTodayClassSessionsForStudent(ward.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            foreach (var c in classes)
                wardTodayClasses.Add((wardName, c));

            var homework = SchoolDataService.GetPendingHomeworkForStudent(ward.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            foreach (var h in homework)
                wardPendingHomework.Add((wardName, h));

            var grades = SchoolDataService.GetRecentGradesForStudent(ward.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
            foreach (var g in grades)
                wardRecentGrades.Add((wardName, g.Course, g.GradeType, g.Score));
        }

        wardTodayClasses = wardTodayClasses.Take(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT).ToList();
        wardPendingHomework = wardPendingHomework.Take(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT).ToList();
        wardRecentGrades = wardRecentGrades.Take(FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT).ToList();
    }

    private void ShowWardGradeDetailsModal(Student ward)
    {
        selectedWardForGrades = ward;
        if (ward.LearningPathId > 0)
        {
            selectedWardLearningPath = SchoolDataService.GetLearningPathForGradeManagement(ward.LearningPathId ?? 0);
            showGuardianGradeDetailsModal = true;
        }
    }

    private void CloseGuardianGradeDetailsModal()
    {
        showGuardianGradeDetailsModal = false;
        selectedWardForGrades = null;
        selectedWardLearningPath = null;
    }

    private async Task LoadTeacherDashboardData()
    {
        var person = await PermissionService.GetCurrentPersonAsync();
        if (person == null) return;

        currentTeacher = SchoolDataService.GetStaff()
            .FirstOrDefault(s => s.PersonId == person.Id);

        if (currentTeacher == null) return;

        todayTeacherClasses = SchoolDataService.GetTodayClassSessionsForTeacher(currentTeacher.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
        recentHomeworkSubmissions = SchoolDataService.GetRecentHomeworkSubmissionsForTeacher(currentTeacher.Id, FcmsConstants.DEFAULT_DASHBOARD_LIST_COUNT);
    }

    public void Dispose()
    {
        timer?.Dispose();

        lock (refreshLock)
        {
            RefreshRequested -= HandleRefreshRequest;
        }
    }

}