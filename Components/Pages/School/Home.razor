@page "/"
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject ISchoolDataService SchoolDataService
@inject IPermissionService PermissionService
@using FcmsPortalUI.Components.Pages.Shared
@using FcmsPortalUI.Services
@using FcmsPortal.Models
@using FcmsPortal.Enums
@using FcmsPortal
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@implements IDisposable


<div class="container-fluid py-4">
    <!-- Top Row -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <div>
                <span class="fw-normal text-danger"
                      style="font-family: 'Calisto MT', 'Book Antiqua', 'Palatino Linotype', serif; font-size: 2.8rem; letter-spacing: 0.5px;">
                    Welcome,
                </span>
                <span class="text-success fw-normal"
                      style="font-family: 'Calisto MT', 'Book Antiqua', 'Palatino Linotype', serif; font-size: 3rem; letter-spacing: 0.5px;">
                    @userFirstName
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="text-muted fs-6">
                @currentDateTime.ToString("dddd, MMMM d, yyyy, hh:mm tt")
            </div>
        </div>
    </div>

    <!-- Main Body -->
    <div class="row">
        <!-- Left Main Content -->
        <div class="col-lg-9">
            <!-- Center Space with Quote -->
            <div style="height: 45vh; display: flex; align-items: center; justify-content: center;">
                @if (randomQuote != null)
                {
                    <div class="text-center px-5">
                        <blockquote class="blockquote" style="font-family: Garamond, 'Cormorant Garamond', 'Goudy Old Style', serif; font-style: italic; font-size: 1.2rem; color: #555; line-height: 1.6;">
                            "@randomQuote.Text"
                        </blockquote>
                        <footer class="blockquote-footer mt-3" style="font-size: 0.6rem; font-style: italic;">
                            @randomQuote.Author
                        </footer>
                    </div>
                }
            </div>

            <!-- Horizontal Info Bar - Staff View -->
            <AuthorizeView Roles="Developer,Staff">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row text-center align-items-center">
                                <!-- Quick Links or General Info -->
                                <div class="col-md-12">
                                    <i class="fa fa-briefcase text-info me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted">
                                        Your work schedule and duties can be found in the
                                        <a href="/staff-resources" class="text-decoration-none">Staff Resources</a> section.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Teacher View -->
            <AuthorizeView Roles="Developer,Teacher">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/teacher-dashboard" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-6 border-end">
                                    <i class="fa fa-chalkboard-teacher text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Today's Classes</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Mathematics - Grade 10A at 9:00 AM</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">4 classes scheduled today</span>
                                </div>

                                <!-- Submitted Homework -->
                                <div class="col-md-6">
                                    <i class="fa fa-file-alt text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Homework Submissions</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">15 new submissions</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">Pending review from 3 classes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Student View -->
            <AuthorizeView Roles="Developer,Student">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-4 border-end">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-chalkboard-teacher text-primary" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Today's Classes</span>
                                    </div>
                                    @if (todayStudentClasses.Any())
                                    {
                                        @foreach (var schedule in todayStudentClasses)
                                        {
                                            <div class="mb-1">
                                                <strong style="font-size: 0.95rem;">@schedule.ClassSession?.Course</strong>
                                                <span class="text-muted" style="font-size: 0.85rem;">at @schedule.DateTime.ToString("h:mm tt")</span>
                                            </div>
                                        }
                                        @if (currentStudent?.LearningPathId > 0)
                                        {
                                            <a href="/learningpath/@currentStudent.LearningPathId/schedules?date=@DateTime.Today.ToString("yyyy-MM-dd")"
                                               class="text-decoration-none" style="font-size: 0.85rem;">
                                                View All <i class="fa fa-arrow-right ms-1"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0" style="font-size: 0.85rem;">
                                            <em>No classes scheduled today.</em>
                                        </p>
                                    }
                                </div>

                                <!-- Pending Homework -->
                                <div class="col-md-4 border-end">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-tasks text-warning" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Pending Homework</span>
                                    </div>
                                    @if (pendingStudentHomework.Any())
                                    {
                                        @foreach (var homework in pendingStudentHomework)
                                        {
                                            <div class="mb-1 text-center">
                                                <strong style="font-size: 0.95rem;">@homework.Title</strong>
                                                <span class="text-muted d-block" style="font-size: 0.85rem;">
                                                    Due: @homework.DueDate.ToString("MMM d, yyyy")
                                                </span>
                                            </div>
                                        }
                                        @if (currentStudent?.LearningPathId > 0)
                                        {
                                            <a href="/learningpath/@currentStudent.LearningPathId/schedules?date=@DateTime.Today.ToString("yyyy-MM-dd")"
                                               class="text-decoration-none" style="font-size: 0.85rem;">
                                                View All <i class="fa fa-arrow-right ms-1"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0 text-center" style="font-size: 0.85rem;">
                                            <em>No pending homework.</em>
                                        </p>
                                    }
                                </div>

                                 <!-- Recent Grades -->
                                <div class="col-md-4">
                                    <div class="text-center mb-2">
                                        <i class="fa fa-award text-success" style="font-size: 1.3rem;"></i>
                                        <span class="text-muted small d-block mt-2">Recent Grades</span>
                                    </div>
                                    @if (recentStudentGrades.Any())
                                    {
                                        @foreach (var grade in recentStudentGrades)
                                        {
                                            <div class="mb-1 text-center">
                                                <strong style="font-size: 0.95rem;">@grade.Course @grade.GradeType</strong>
                                                <span class="text-muted" style="font-size: 0.85rem;">@grade.Score</span>
                                            </div>
                                        }
                                        @if (currentStudent != null && studentLearningPath != null)
                                        {
                                            <div class="text-center mt-2">
                                                <a href="javascript:void(0)" @onclick="ShowStudentGradeDetailsModal" 
                                                   class="text-decoration-none" style="font-size: 0.85rem;">
                                                    View All <i class="fa fa-arrow-right ms-1"></i>
                                                </a>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0 text-center" style="font-size: 0.85rem;">
                                            <em>No grades recorded yet.</em>
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Guardian View -->
            <AuthorizeView Roles="Developer,Guardian">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/student-dashboard" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Today's Class Schedule -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-chalkboard-teacher text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's Today's Classes</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Mathematics at 9:00 AM</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">5 classes scheduled</span>
                                </div>

                                <!-- Pending Homework -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-tasks text-warning me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's Pending Homework</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">2 assignments due today</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">Science & English</span>
                                </div>

                                <!-- Recent Grades -->
                                <div class="col-md-4">
                                    <i class="fa fa-award text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Ward's New Grades Available</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Math Quiz - 85%</strong>
                                    <span class="text-muted" style="font-size: 0.85rem;">2 more results ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>

            <!-- Horizontal Info Bar - Admin/Principal/Developer View -->
            <AuthorizeView Roles="Developer,Principal,Admin">
                <Authorized>
                    <div class="card shadow-sm">
                        <div class="card-body position-relative">
                            <!-- View All Link - Top Right -->
                            <a href="/reports" class="text-decoration-none position-absolute top-0 end-0 mt-2 me-3" style="font-size: 0.85rem;">
                                View All <i class="fa fa-arrow-right ms-1"></i>
                            </a>

                            <div class="row text-center">
                                <!-- Attendance Report -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-user-check text-primary me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Attendance Report</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 9:00 AM</strong>
                                </div>

                                <!-- Teachers Remark Report -->
                                <div class="col-md-4 border-end">
                                    <i class="fa fa-comments text-success me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Teachers Remark</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 10:30 AM</strong>
                                </div>

                                <!-- Learning Path Report -->
                                <div class="col-md-4">
                                    <i class="fa fa-chart-line text-info me-2" style="font-size: 1.3rem;"></i>
                                    <span class="text-muted small d-block mt-2">Learning Path Report</span>
                                    <strong class="d-block mt-1" style="font-size: 0.95rem;">Posted today at 2:15 PM</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-3">
            <!-- Semester Timeline -->
            <div class="card mb-3 border-0" style="border-left: 3px solid #17a2b8 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="mb-0 text-info fw-semibold">
                        <i class="fa fa-calendar-alt me-2"></i>Academic Year & Semester
                    </h6>
                </div>
                <div class="card-body pt-2 pb-3">
                    @if (!string.IsNullOrEmpty(currentAcademicYear))
                    {
                        <p class="mb-1 text-muted" style="font-size: 0.875rem;">
                            <strong>Current:</strong> @currentAcademicYear - @currentSemester Semester
                        </p>
                        @if (semesterStartDate.HasValue)
                        {
                            <p class="mb-1 text-muted" style="font-size: 0.875rem;">
                                <strong>Semester Start:</strong> @semesterStartDate.Value.ToString("MMM dd, yyyy")
                            </p>
                        }
                        @if (examsStartDate.HasValue)
                        {
                            <p class="mb-1 text-muted" style="font-size: 0.875rem;">
                                <strong>Exam Start:</strong> @examsStartDate.Value.ToString("MMM dd, yyyy")
                            </p>
                        }
                        @if (semesterEndDate.HasValue)
                        {
                            <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                                <strong>Semester Ends:</strong> @semesterEndDate.Value.ToString("MMM dd, yyyy")
                            </p>
                        }
                    }
                    else
                    {
                        <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                            <em>No active semester information available.</em>
                        </p>
                    }
                </div>
            </div>

            <!-- Announcements -->
            <div class="card mb-3 border-0" style="border-left: 3px solid #28a745 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="mb-0 text-success fw-semibold">
                        <i class="fa fa-bullhorn me-2"></i>Announcements
                    </h6>
                </div>
                <div class="card-body pt-2 pb-3">
                    @if (announcements != null && announcements.Any())
                    {
                        @foreach (var announcement in announcements)
                        {
                            <p class="mb-2 text-danger" style="font-size: 0.875rem;">
                                • @announcement.Message
                            </p>
                        }
                    }
                    else
                    {
                        <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                            <em>No announcements at this time.</em>
                        </p>
                    }
                </div>
            </div>

            <!-- Upcoming Events & Meetings -->
            <div class="card border-0" style="border-left: 3px solid #007bff !important; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="mb-0 text-primary fw-semibold">
                        <i class="fa fa-calendar-check me-2"></i>Upcoming Events & Meetings
                    </h6>
                </div>
                <div class="card-body pt-2 pb-3">
                    @if (todayEventOrMeeting != null)
                    {
                        <p class="mb-2 text-muted" style="font-size: 0.875rem;">
                            • <strong>Today:</strong> @GetEventOrMeetingName(todayEventOrMeeting) at @todayEventOrMeeting.DateTime.ToString("h:mm tt")
                        </p>
                    }
                    @if (tomorrowEventOrMeeting != null)
                    {
                        <p class="mb-2 text-muted" style="font-size: 0.875rem;">
                            • <strong>Tomorrow:</strong> @GetEventOrMeetingName(tomorrowEventOrMeeting) at @tomorrowEventOrMeeting.DateTime.ToString("h:mm tt")
                        </p>
                    }
                    @if (dayAfterEventOrMeeting != null)
                    {
                        <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                            • <strong>In 2 days:</strong> @GetEventOrMeetingName(dayAfterEventOrMeeting) at @dayAfterEventOrMeeting.DateTime.ToString("h:mm tt")
                        </p>
                    }
                    @if (todayEventOrMeeting == null && tomorrowEventOrMeeting == null && dayAfterEventOrMeeting == null)
                    {
                        <p class="mb-0 text-muted" style="font-size: 0.875rem;">
                            <em>No upcoming events or meetings.</em>
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
    <!-- Student Grade Details Modal -->
@if (currentStudent != null && studentLearningPath != null)
{
    <StudentGradeDetailsModal IsVisible="showStudentGradeDetailsModal"
                              Student="currentStudent"
                              LearningPath="studentLearningPath"
                              OnClose="CloseStudentGradeDetailsModal" />
}
</div>

@code {
    //private School? school;
    private string userFirstName = "User";
    private DateTime currentDateTime = DateTime.Now;
    private System.Threading.Timer? timer;
    // Semester Timeline Data
    private string currentAcademicYear = "";
    private string currentSemester = "";
    private DateTime? semesterStartDate;
    private DateTime? semesterEndDate;
    private DateTime? examsStartDate;

    private List<Announcement> announcements = new();
    private Quote? randomQuote;

    private ScheduleEntry? todayEventOrMeeting;
    private ScheduleEntry? tomorrowEventOrMeeting;
    private ScheduleEntry? dayAfterEventOrMeeting;

    private static event Action? RefreshRequested;
    private static object refreshLock = new object();

    // Student Dashboard Data
    private Student? currentStudent;
    private List<ScheduleEntry> todayStudentClasses = new();
    private List<Homework> pendingStudentHomework = new();
    private List<(string Course, GradeType GradeType, double Score)> recentStudentGrades = new();
    private LearningPath? studentLearningPath;
    private bool showStudentGradeDetailsModal = false;

    protected override async Task OnInitializedAsync()
    {
        lock (refreshLock)
        {
            RefreshRequested += HandleRefreshRequest;
        }

        var person = await PermissionService.GetCurrentPersonAsync();
        if (person != null && !string.IsNullOrWhiteSpace(person.FirstName))
        {
            userFirstName = person.FirstName;
        }
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
        await LoadStudentDashboardData();
        timer = new System.Threading.Timer(UpdateTime, null, TimeSpan.Zero, TimeSpan.FromSeconds(60));
    }

    public static void TriggerSchoolDataRefresh()
    {
        lock (refreshLock)
        {
            RefreshRequested?.Invoke();
        }
    }

    private void HandleRefreshRequest()
    {
        LoadSemesterTimeline();
        LoadAnnouncements();
        LoadRandomQuote();
        LoadUpcomingEvents();
    }

    private void LoadSemesterTimeline()
    {
        var academicPeriod = SchoolDataService.GetCurrentAcademicPeriod();

        if (academicPeriod != null)
        {
            currentAcademicYear = academicPeriod.AcademicYear;
            currentSemester = academicPeriod.Semester.ToString();
            semesterStartDate = academicPeriod.SemesterStartDate;
            semesterEndDate = academicPeriod.SemesterEndDate;
            examsStartDate = academicPeriod.ExamsStartDate;
        }
    }

    private void LoadAnnouncements()
    {
        announcements = SchoolDataService.GetActiveAnnouncements();
    }

    private void LoadRandomQuote()
    {
        var quotes = SchoolDataService.GetAllQuotes();
        randomQuote = LogicMethods.GetRandomQuote(quotes);
    }

    private void LoadUpcomingEvents()
    {
        todayEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today);
        tomorrowEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(1));
        dayAfterEventOrMeeting = SchoolDataService.GetLatestEventOrMeetingForDate(DateTime.Today.AddDays(2));
    }

    private string GetEventOrMeetingName(ScheduleEntry entry)
    {
        return entry.Title;
    }

    private void UpdateTime(object? state)
    {
        currentDateTime = DateTime.Now;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadStudentDashboardData()
    {
        var person = await PermissionService.GetCurrentPersonAsync();
        if (person == null) return;

        currentStudent = SchoolDataService.GetStudents()
            .FirstOrDefault(s => s.PersonId == person.Id);

        if (currentStudent != null)
        {
            todayStudentClasses = SchoolDataService.GetTodayClassSessionsForStudent(currentStudent.Id, 5);
            pendingStudentHomework = SchoolDataService.GetPendingHomeworkForStudent(currentStudent.Id, 5);
            recentStudentGrades = SchoolDataService.GetRecentGradesForStudent(currentStudent.Id, 5);
        
            if (currentStudent.LearningPathId > 0)
            {
                studentLearningPath = SchoolDataService.GetLearningPathForGradeManagement(currentStudent.LearningPathId ?? 0);
            }
        }
    }

    private void ShowStudentGradeDetailsModal()
    {
        if (currentStudent != null && studentLearningPath != null)
        {
            showStudentGradeDetailsModal = true;
        }
    }

    private void CloseStudentGradeDetailsModal()
    {
        showStudentGradeDetailsModal = false;
    }

    public void Dispose()
    {
        timer?.Dispose();

        lock (refreshLock)
        {
            RefreshRequested -= HandleRefreshRequest;
        }
    }

}