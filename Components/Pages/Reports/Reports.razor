@page "/reports"
@using FcmsPortal.Models
@using FcmsPortal.Services
@using FcmsPortal
@inject ISchoolDataService SchoolDataService

<div class="container-fluid mt-3">
    <div class="row mb-3">
        <div class="col">
            <h2>
                <i class="fa fa-chart-bar me-2"></i>Reports
            </h2>
        </div>
    </div>

    <!-- Attendance Reports Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">
                <i class="fa fa-calendar-check me-2"></i>Attendance Reports
            </h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="academicYear" class="form-label">Academic Year:</label>
                    <select class="form-select" id="academicYear" @bind="selectedAcademicYear" @bind:after="OnFiltersChanged">
                        <option value="">Select Academic Year</option>
                        @foreach (var year in availableAcademicYears)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="semester" class="form-label">Semester:</label>
                    <select class="form-select" id="semester" @bind="selectedSemester" @bind:after="OnFiltersChanged">
                        <option value="">Select Semester</option>
                        @if (!string.IsNullOrEmpty(selectedAcademicYear))
                        {
                            @foreach (var semester in availableSemesters)
                            {
                                <option value="@semester">@semester</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="attendanceDate" class="form-label">Select Date:</label>
                    <input type="date" class="form-control" id="attendanceDate" @bind="selectedDate" @bind:after="OnDateChanged" />
                </div>

            </div>

            @if (!string.IsNullOrEmpty(selectedAcademicYear) && !string.IsNullOrEmpty(selectedSemester) && filteredLearningPaths.Any())
            {
                <div class="row">
                    @foreach (var learningPath in filteredLearningPaths)
                    {
                        <div class="col-md-12 mb-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fa fa-graduation-cap me-2"></i>
                                        @Util.GetLearningPathName(learningPath)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="text-primary">Semester Summary</h6>
                                            <div class="row text-center">
                                                <div class="col-3">
                                                    <div class="text-info">
                                                        <h5>@learningPath.Students.Count</h5>
                                                        <small>Total Students</small>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="text-success">
                                                        <h5>@learningPath.AttendanceLog.Count</h5>
                                                        <small>Days Recorded</small>
                                                    </div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="text-warning">
                                                        @{
                                                            double avgRate = 0;
                                                            if (learningPath.AttendanceLog.Any() && learningPath.Students.Any())
                                                            {
                                                                var totalPossible = learningPath.Students.Count * learningPath.AttendanceLog.Count;
                                                                var totalPresent = learningPath.AttendanceLog.Sum(log => log.PresentStudents?.Count ?? 0);
                                                                avgRate = totalPossible > 0 ? (double)totalPresent / totalPossible * 100 : 0;
                                                            }
                                                        }
                                                        <h5>@avgRate.ToString("F1")%</h5>
                                                        <small>Avg Attendance</small>
                                                    </div>
                                                </div>
                                            </div>

                                            @{
                                                var dailyAttendance = learningPath.AttendanceLog
                                                .FirstOrDefault(log => log.TimeStamp.Date == selectedDate.Date);
                                            }

                                            @if (dailyAttendance != null)
                                            {
                                                <div class="mt-3">
                                                    <h6 class="text-success">Daily Attendance (@selectedDate.ToString("MMMM dd, yyyy"))</h6>
                                                    <div class="row text-center">
                                                        <div class="col-4">
                                                            <div class="text-success">
                                                                <h5>@(dailyAttendance.PresentStudents?.Count ?? 0)</h5>
                                                                <small>Present</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="text-danger">
                                                                <h5>@(dailyAttendance.AbsentStudents?.Count ?? 0)</h5>
                                                                <small>Absent</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="text-primary">
                                                                <h5>@((dailyAttendance.PresentStudents?.Count ?? 0) + (dailyAttendance.AbsentStudents?.Count ?? 0))</h5>
                                                                <small>Total</small>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    @if (dailyAttendance.TimeStamp != default)
                                                    {
                                                        <small class="text-muted d-block mt-2">
                                                            <i class="fa fa-clock me-1"></i>
                                                            Recorded at @dailyAttendance.TimeStamp.ToString("HH:mm")
                                                            by @(dailyAttendance.Teacher?.Person?.FirstName ?? "Unknown")
                                                        </small>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="col-md-4 d-flex flex-column justify-content-center">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary" @onclick="() => ViewDailyAttendance(learningPath.Id)">
                                                    <i class="fa fa-calendar-day me-2"></i>Daily Attendance View
                                                </button>
                                                <button class="btn btn-outline-success" @onclick="() => ViewSemesterAttendance(learningPath.Id)">
                                                    <i class="fa fa-chart-line me-2"></i>Semester Attendance View
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(selectedAcademicYear) && !string.IsNullOrEmpty(selectedSemester))
                {
                    <div class="text-center py-4">
                        <i class="fa fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No attendance records found</h5>
                        <p class="text-muted">
                            @if (selectedDate == default)
                            {
                                <span>Please select a date to view attendance records.</span>
                            }
                            else
                            {
                                <span>No attendance records found for @selectedDate.ToString("MMMM dd, yyyy") in @selectedAcademicYear @selectedSemester semester.</span>
                            }
                        </p>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fa fa-filter fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Select filters to view attendance</h5>
                        <p class="text-muted">Please select Academic Year and Semester to continue.</p>
                    </div>
                }
            }

        </div>
    </div>
</div>

@code {
    private School school;
    private DateTime selectedDate = DateTime.Today;
    private string selectedAcademicYear = "";
    private string selectedSemester = "";
    private List<string> availableAcademicYears = new();
    private List<string> availableSemesters = new();
    private List<LearningPath> filteredLearningPaths = new();

    protected override void OnInitialized()
    {
        school = SchoolDataService.GetSchool();
        LoadAvailableAcademicYears();
        InitializeWithCurrentData();
    }

    private void InitializeWithCurrentData()
    {
        if (availableAcademicYears.Any())
        {
            selectedAcademicYear = availableAcademicYears.First(); 
            LoadAvailableSemesters();

            if (availableSemesters.Any())
            {
                selectedSemester = availableSemesters.Last(); 
                selectedDate = DateTime.Today;
                LoadFilteredLearningPaths();
            }
        }
    }

    private void LoadAvailableAcademicYears()
    {
        availableAcademicYears = school.LearningPath
            .Select(lp => lp.AcademicYear)
            .Distinct()
            .OrderByDescending(year => year)
            .ToList();
    }

    private void OnFiltersChanged()
    {
        if (!string.IsNullOrEmpty(selectedAcademicYear))
        {
            LoadAvailableSemesters();
        }

        if (!string.IsNullOrEmpty(selectedAcademicYear) && !string.IsNullOrEmpty(selectedSemester))
        {
            LoadFilteredLearningPaths();
        }
    }

    private void LoadAvailableSemesters()
    {
        availableSemesters = school.LearningPath
            .Where(lp => lp.AcademicYear == selectedAcademicYear)
            .Select(lp => lp.Semester.ToString())
            .Distinct()
            .OrderBy(semester => semester)
            .ToList();
    }

    private void OnDateChanged()
    {
        if (!string.IsNullOrEmpty(selectedAcademicYear) && !string.IsNullOrEmpty(selectedSemester))
        {
            LoadFilteredLearningPaths();
        }
    }

    private void LoadFilteredLearningPaths()
    {
        filteredLearningPaths = school.LearningPath
            .Where(lp => lp.AcademicYear == selectedAcademicYear &&
                         lp.Semester.ToString() == selectedSemester)
            .ToList();
    }

    private void ViewDailyAttendance(int learningPathId)
    {
        Console.WriteLine($"Navigate to daily attendance view for Learning Path {learningPathId}");
    }

    private void ViewSemesterAttendance(int learningPathId)
    {
        Console.WriteLine($"Navigate to semester attendance view for Learning Path {learningPathId}");
    }
}