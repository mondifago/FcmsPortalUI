@page "/classes"
@using FcmsPortalUI.Services
@using FcmsPortal.Models
@using FcmsPortal.Enums
@using FcmsPortalUI.Components.Pages.Shared
@inject ISchoolDataService SchoolDataService
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Learning Paths</h2>

    @if (canManageLearningPaths)
    {
        <a href="/learningpath/create" class="btn btn-primary">
            <i class="fa fa-plus me-2"></i> Add New Learning Path
        </a>
    }
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label for="academicYear" class="form-label">Academic Year:</label>
                <select class="form-select" id="academicYear" @bind="selectedAcademicYear" @bind:after="FilterLearningPaths">
                    <option value="">Select Academic Year</option>
                    @foreach (var year in availableAcademicYears)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label for="semester" class="form-label">Semester:</label>
                <select class="form-select" id="semester" @bind="selectedSemester" @bind:after="FilterLearningPaths">
                    <option value="">Select Semester</option>
                    @foreach (var semester in Enum.GetValues(typeof(Semester)).Cast<Semester>())
                    {
                        <option value="@semester">@semester</option>
                    }
                </select>
            </div>
        </div>
    </div>
</div>

@if (!filtersApplied)
{
    <div class="alert alert-info">
        <i class="fa fa-info-circle me-2"></i>
        Please select filters to view learning paths.
    </div>
}
else if (!visibleLearningPaths.Any())
{
    <div class="alert alert-warning">
        <i class="fa fa-exclamation-triangle me-2"></i>
        No learning paths found matching the selected filters.
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Education Level</th>
                        <th>Class Level</th>
                        <th>Semester</th>
                        <th>Academic Year</th>
                        <th>Approval Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var learningPath in visibleLearningPaths)
                    {
                        <tr>
                            <td>@learningPath.Id</td>
                            <td>@learningPath.EducationLevel</td>
                            <td>@learningPath.ClassLevel</td>
                            <td>@learningPath.Semester</td>
                            <td>@learningPath.AcademicYear</td>
                            <td>
                                <span class="@Util.GetApprovalStatusBadgeClass(learningPath.ApprovalStatus)">
                                    @learningPath.ApprovalStatus
                                </span>
                            </td>
                            <td>
                                @if (learningPath.ApprovalStatus == PrincipalApprovalStatus.Review)
                                {   
                                }
                                else
                                {
                                    <div class="btn-group" role="group">
                                        <a href="/learningpaths/details/@learningPath.Id" class="btn btn-sm btn-info">
                                            <span class="fa fa-eye"></span> Details
                                        </a>
                                        @if (learningPath.ApprovalStatus == PrincipalApprovalStatus.Pending && canManageLearningPaths)
                                        {
                                            <a href="/learningpath/edit/@learningPath.Id" class="btn btn-sm btn-warning">
                                                <span class="fa fa-pencil"></span> Edit
                                            </a>
                                        }
                                        @if (canManageLearningPaths)
                                        {
                                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteConfirmation(learningPath)">
                                                <span class="fa fa-trash"></span> Delete
                                            </button>
                                        }
                                    </div>
                                }
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<ConfirmDeleteModal IsVisible="showDeleteConfirmation"
                    Title="Confirm Delete"
                    Message="Are you sure you want to delete this Learning Path?"
                    OnConfirm="DeleteLearningPath"
                    OnCancel="CancelDelete" />

<ErrorDisplayModal IsVisible="showErrorModal"
                   Title="Delete Error"
                   Message="@errorMessage"
                   OnClose="CloseErrorModal" />


@code {
    private IEnumerable<LearningPath> learningPaths = Enumerable.Empty<LearningPath>();
    private LearningPath? learningPathToDelete;
    private List<LearningPath> visibleLearningPaths = new();
    private List<string> availableAcademicYears = new();
    private Person? currentUser;
    private int? currentUserId;
    private bool canManageLearningPaths;
    private bool isStaff;
    private bool isGuardian;
    private bool isStudent;
    private string selectedAcademicYear = "";
    private string selectedSemester = "";
    private bool filtersApplied = false;
    private bool showDeleteConfirmation = false;
    private bool showErrorModal = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await PermissionService.GetCurrentUserIdAsync();
        currentUser = await PermissionService.GetCurrentPersonAsync();

        canManageLearningPaths = await PermissionService.IsInAnyRoleAsync("Developer", "Principal", "Admin", "Teacher");
        isStaff = await PermissionService.IsInRoleAsync("Staff");
        isGuardian = await PermissionService.IsInRoleAsync("Guardian");
        isStudent = await PermissionService.IsInRoleAsync("Student");

        LoadLearningPaths();
        if (isGuardian)
        {
            var guardian = SchoolDataService.GetGuardians()
                .FirstOrDefault(g => g.PersonId == currentUser?.Id);

            var wardIds = guardian?.Wards
                .Select(w => w.LearningPathId)
                .Where(id => id != null)
                .ToList() ?? new();

            learningPaths = learningPaths.Where(lp => wardIds.Contains(lp.Id));
        }
        else if (isStudent)
        {
            var student = SchoolDataService.GetStudents()
                .FirstOrDefault(s => s.PersonId == currentUser?.Id);

            if (student?.LearningPathId != null)
                learningPaths = learningPaths.Where(lp => lp.Id == student.LearningPathId);
        }
        LoadAvailableFilters();
        InitializeWithCurrentAcademicPeriod();
    }

    public void LoadLearningPaths()
    {
        learningPaths = SchoolDataService.GetAllLearningPaths();
    }

    private void InitializeWithCurrentAcademicPeriod()
    {
        var currentPeriod = SchoolDataService.GetCurrentAcademicPeriod();

        if (currentPeriod != null)
        {
            selectedAcademicYear = currentPeriod.AcademicYear;
            selectedSemester = currentPeriod.Semester.ToString();
            FilterLearningPaths();
        }
    }

    private void LoadAvailableFilters()
    {
        availableAcademicYears = learningPaths
            .Select(lp => lp.AcademicYear)
            .Distinct()
            .OrderByDescending(y => y)
            .ToList();
    }

    private void FilterLearningPaths()
    {
        filtersApplied = !string.IsNullOrEmpty(selectedAcademicYear) ||
                         !string.IsNullOrEmpty(selectedSemester);

        if (!filtersApplied)
        {
            visibleLearningPaths = new List<LearningPath>();
            return;
        }

        visibleLearningPaths = learningPaths.ToList();

        if (!string.IsNullOrEmpty(selectedAcademicYear))
        {
            visibleLearningPaths = visibleLearningPaths
                .Where(lp => lp.AcademicYear == selectedAcademicYear)
                .ToList();
        }

        if (!string.IsNullOrEmpty(selectedSemester) && Enum.TryParse<Semester>(selectedSemester, out var semester))
        {
            visibleLearningPaths = visibleLearningPaths
                .Where(lp => lp.Semester == semester)
                .ToList();
        }

    }

    private void DeleteConfirmation(LearningPath learningPath)
    {
        learningPathToDelete = learningPath;
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        learningPathToDelete = null;
        showDeleteConfirmation = false;
    }

    private void DeleteLearningPath()
    {
        try
        {
            if (learningPathToDelete != null)
            {
                SchoolDataService.DeleteLearningPath(learningPathToDelete.Id);
                LoadLearningPaths();
                LoadAvailableFilters();
                FilterLearningPaths();
            }

            showDeleteConfirmation = false;
            learningPathToDelete = null;
        }
        catch (BusinessRuleException ex)
        {
            errorMessage = ex.Message;
            showErrorModal = true;
            showDeleteConfirmation = false;
            learningPathToDelete = null;
            StateHasChanged();
        }
    }

    private void CloseErrorModal()
    {
        showErrorModal = false;
        errorMessage = "";
        StateHasChanged();
    }
}