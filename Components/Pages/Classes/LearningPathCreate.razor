@page "/learningpath/create"
@rendermode InteractiveServer
@inject ISchoolDataService SchoolDataService
@inject NavigationManager NavigationManager
@using FcmsPortal.Models
@using FcmsPortal.Enums
@using FcmsPortalUI.Services
@using FcmsPortal
@using FcmsPortal.Constants
@using FcmsPortalUI.Components.Pages.Shared

<h3>Create Learning Path</h3>

@if (templateApplied && showTemplateAlert)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fa fa-magic"></i>
        <strong>Template Applied!</strong> Using template from @templateSource academic year.
        <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ClearTemplate">
            <i class="fa fa-refresh"></i> Start Fresh
        </button>
        <button type="button" class="btn-close" @onclick="DismissTemplateAlert"></button>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <LearningPathForm LearningPath="learningPath"
                          SubmitButtonText="Create Learning Path"
                          OnSubmit="HandleValidSubmit"
                          OnCancel="NavigateToList"
                          OnEducationLevelChanged="HandleEducationLevelChanged"
                          OnClassLevelChanged="HandleClassLevelChanged"
                          OnSemesterChanged="HandleSemesterChanged"
                          TemplateApplied="templateApplied"
                          TemplateSource="templateSource"
                          OnClearTemplate="ClearTemplate" />
    </div>
</div>

@code {
    private LearningPath learningPath = new LearningPath();
    private bool templateApplied = false;
    private string templateSource = "";
    private bool showTemplateAlert = true;

    protected override void OnInitialized()
    {
        InitializeNewLearningPath();
    }

    private void InitializeNewLearningPath()
    {
        var currentAcademicPeriod = SchoolDataService.GetCurrentAcademicPeriod();

        if (currentAcademicPeriod != null)
        {
            learningPath = new LearningPath
            {
                Students = new List<Student>(),
                StudentsWithAccess = new List<Student>(),
                Schedule = new List<ScheduleEntry>(),
                AcademicPeriodId = currentAcademicPeriod.Id,
                AcademicYearStart = currentAcademicPeriod.AcademicYearStart,
                Semester = currentAcademicPeriod.Semester,
                SemesterStartDate = currentAcademicPeriod.SemesterStartDate,
                SemesterEndDate = currentAcademicPeriod.SemesterEndDate,
                ExamsStartDate = currentAcademicPeriod.ExamsStartDate ?? DateTime.Now
            };
        }
        else
        {
            var (semester, startDate, endDate) = LogicMethods.GetDefaultSemesterDates();

            learningPath = new LearningPath
            {
                Students = new List<Student>(),
                StudentsWithAccess = new List<Student>(),
                Schedule = new List<ScheduleEntry>(),
                AcademicYearStart = new DateTime(DateTime.Now.Year, FcmsConstants.SEMESTER_1_STARTMONTH, FcmsConstants.SEMESTER_1_STARTDAY),
                Semester = semester,
                SemesterStartDate = startDate,
                SemesterEndDate = endDate,
                ExamsStartDate = DateTime.Now
            };
        }

        templateApplied = false;
        templateSource = "";
        showTemplateAlert = true;
    }

    private void HandleEducationLevelChanged(EducationLevel educationLevel)
    {
        learningPath.EducationLevel = educationLevel;
        CheckAndApplyTemplate();
    }

    private void HandleClassLevelChanged(ClassLevel classLevel)
    {
        learningPath.ClassLevel = classLevel;
        CheckAndApplyTemplate();
    }

    private void HandleSemesterChanged(Semester semester)
    {
        learningPath.Semester = semester;
        CheckAndApplyTemplate();
    }

    private void CheckAndApplyTemplate()
    {
        if (learningPath.EducationLevel != EducationLevel.None &&
            learningPath.ClassLevel != ClassLevel.None)
        {
            if (SchoolDataService.HasTemplate(learningPath.EducationLevel, learningPath.ClassLevel, learningPath.Semester))
            {
                ApplyTemplate();
            }
            else
            {
                ClearTemplateData();
            }
        }
    }

    private void ApplyTemplate()
    {
        var template = SchoolDataService.GetTemplate(learningPath.EducationLevel, learningPath.ClassLevel, learningPath.Semester);
        if (template != null)
        {
            var templatedLearningPath = SchoolDataService.ApplyTemplateToNewLearningPath(template, learningPath.AcademicYearStart);
            if (templatedLearningPath != null)
            {
                templatedLearningPath.Students = learningPath.Students;
                templatedLearningPath.StudentsWithAccess = learningPath.StudentsWithAccess;

                learningPath = templatedLearningPath;

                templateApplied = true;
                templateSource = template.AcademicYear;
                showTemplateAlert = true;

                StateHasChanged();
            }
        }
    }

    private void ClearTemplate()
    {
        var currentEducationLevel = learningPath.EducationLevel;
        var currentClassLevel = learningPath.ClassLevel;
        var currentSemester = learningPath.Semester;
        var currentAcademicYearStart = learningPath.AcademicYearStart;

        InitializeNewLearningPath();

        learningPath.EducationLevel = currentEducationLevel;
        learningPath.ClassLevel = currentClassLevel;
        learningPath.Semester = currentSemester;
        learningPath.AcademicYearStart = currentAcademicYearStart;

        StateHasChanged();
    }

    private void ClearTemplateData()
    {
        if (templateApplied)
        {
            learningPath.Schedule.Clear();
            templateApplied = false;
            templateSource = "";
            StateHasChanged();
        }
    }

    private void DismissTemplateAlert()
    {
        showTemplateAlert = false;
    }

    private void HandleValidSubmit(LearningPath submittedLearningPath)
    {
        SchoolDataService.AddLearningPath(submittedLearningPath);
        NavigateToList();
    }

    private void NavigateToList()
    {
        NavigationManager.NavigateTo("/classes");
    }
}